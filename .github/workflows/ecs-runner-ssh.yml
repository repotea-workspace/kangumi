name: ECS Runner via SSH

on:
  push:
    branches: [mirror-docker-aliyun]
  workflow_dispatch:

env:
  ECS_REGION: cn-shenzhen
  ECS_VSWITCH_ID: vsw-wz9uncyx33urqcxpj8c1p
  ECS_AVAILABILITY_ZONE: cn-shenzhen-e
  ECS_SECURITY_GROUP_ID: sg-wz9eo52rpleayua0e1s6
  ECS_IMAGE_ID: fcos_34_20210529_3_0_3_x64_20G_alibase_20210824.vhd
  #ECS_IMAGE_ID: ubuntu_24_04_x64_20G_alibase_20251102.vhd
  ECS_RUNNER_ADDITIONAL_LABELS: ecs,alicloud,shenzhen
  ECS_INSTANCE_TYPE: ecs.c7a.large
  ECS_SYSTEM_DISK_SIZE: 40
  ECS_SPOT_STRATEGY: SpotAsPriceGo

  ALI_ACCESS_KEY: ${{ secrets.ALI_ACCESS_KEY_AYN }}
  ALI_SECRET_KEY: ${{ secrets.ALI_SECRET_KEY_AYN }}
  GH_RUNNER_PAT: ${{ secrets.GT_0XFE10 }}

  RUNNER_NAME_PREFIX: ecs-runner
  # RUNNER_VERSION: 2.330.0

jobs:
  prepare-password:
    name: Generate ECS instance password
    runs-on: ubuntu-latest
    outputs:
      instance-password: ${{ steps.generate.outputs.password }}
    steps:
      - id: generate
        name: Generate strong password
        run: |
          # Generate 24-char password with mixed case, digits, and allowed special chars
          pw=$(openssl rand -base64 32 | tr -dc 'a-zA-Z0-9()~!@#$%^&*-_+=|<>?/' | head -c24)
          echo "password=$pw" >> "$GITHUB_OUTPUT"

  provision-runner:
    name: Provision ECS runner
    needs: prepare-password
    runs-on: ubuntu-latest
    outputs:
      runner-name: ${{ steps.start.outputs.runner-name }}
      public-ip: ${{ steps.start.outputs.public-ip }}
      instance-password: ${{ steps.start.outputs.instance-password }}
    steps:
      - uses: actions/checkout@v6
      - name: Start Aliyun ECS GitHub runner
        id: start
        uses: ./github-actions/ecs-github-runner
        with:
          mode: start
          register_runner: "false"
          expose_instance_password: "true"
          ali_access_key: ${{ env.ALI_ACCESS_KEY }}
          ali_secret_key: ${{ env.ALI_SECRET_KEY }}
          ali_region: ${{ env.ECS_REGION }}
          vswitch_id: ${{ env.ECS_VSWITCH_ID }}
          availability_zone: ${{ env.ECS_AVAILABILITY_ZONE }}
          security_group_id: ${{ env.ECS_SECURITY_GROUP_ID }}
          image_id: ${{ env.ECS_IMAGE_ID }}
          ali_ecs_name: ${{ env.RUNNER_NAME_PREFIX }}-${{ github.run_id }}-${{ github.run_attempt }}
          ali_ecs_instance_type: ${{ env.ECS_INSTANCE_TYPE }}
          host_name: ${{ env.RUNNER_NAME_PREFIX }}-${{ github.run_id }}-${{ github.run_attempt }}
          system_disk_size: ${{ env.ECS_SYSTEM_DISK_SIZE }}
          # key_pair_name: "" # 使用密码登录时保持为空
          instance_password: ${{ needs.prepare-password.outputs.instance-password }}
          # 抢占模式
          spot_strategy: ${{ env.ECS_SPOT_STRATEGY }}


  manual-instructions:
    name: Run commands via SSH
    needs: provision-runner
    runs-on: ubuntu-latest
    steps:
      - name: Print connection info
        run: |
          echo "::notice::ECS ready."
          echo "::notice::Public IP: ${{ needs.provision-runner.outputs.public-ip }}"
          echo "::notice::Username: root"

      - name: Wait for SSH using wait-for-port
        uses: docker://ghcr.io/repotea-workspace/kangumi/wait-for-port:latest
        with:
          args: ${{ needs.provision-runner.outputs.public-ip }} 22 10

      - name: Execute remote commands via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ needs.provision-runner.outputs.public-ip }}
          username: root
          password: ${{ needs.provision-runner.outputs.instance-password }}
          timeout: 60s
          script: |
            set -ex
            echo "=== System Info ==="
            uname -a
            cat /etc/os-release

            echo "=== CPU Info ==="
            lscpu | head -20

            echo "=== Memory Info ==="
            free -h

            echo "=== Disk Info ==="
            df -h

            echo "=== Network Info ==="
            ip addr show

            echo "=== Install some packages ==="
            apt-get update -qq
            apt-get install -y -qq curl wget git

            echo "=== Docker Info ==="
            docker version
            docker ps

            echo "=== Done ==="


  destroy-runner:
    name: Destroy ECS runner
    needs:
      - provision-runner
      - manual-instructions
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Destroy Aliyun ECS GitHub runner
        uses: ./github-actions/ecs-github-runner
        with:
          mode: destroy
          register_runner: "false"
          ali_access_key: ${{ env.ALI_ACCESS_KEY }}
          ali_secret_key: ${{ env.ALI_SECRET_KEY }}
          ali_region: ${{ env.ECS_REGION }}
          vswitch_id: ${{ env.ECS_VSWITCH_ID }}
          availability_zone: ${{ env.ECS_AVAILABILITY_ZONE }}
          security_group_id: ${{ env.ECS_SECURITY_GROUP_ID }}
          image_id: ${{ env.ECS_IMAGE_ID }}
