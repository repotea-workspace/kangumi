name: ecs-runner

on:
  push:
    branches: [ecs-github-runner]
  workflow_dispatch:

env:
  ECS_REGION: cn-hongkong
  ECS_VSWITCH_ID: vsw-j6cxoruwpjx23479pcwj8 # 替换为香港地域的 VSwitch ID
  ECS_AVAILABILITY_ZONE: cn-hongkong-b # 替换为实际可用区
  ECS_SECURITY_GROUP_ID: sg-j6cdwrlcl9xbzksin9of # 替换为安全组 ID
  ECS_IMAGE_ID: ubuntu_24_04_x64_20G_alibase_20251102.vhd # 替换为需要的镜像 ID
  ECS_RUNNER_ADDITIONAL_LABELS: ecs,alicloud,hk # 可按需调整
  ECS_INSTANCE_TYPE: ecs.c7a.large # 如需不同规格请修改
  ECS_SYSTEM_DISK_SIZE: 60 # 根据需求调整系统盘容量

  ALI_ACCESS_KEY: ${{ secrets.ALI_ACCESS_KEY_AYN }}
  ALI_SECRET_KEY: ${{ secrets.ALI_SECRET_KEY_AYN }}
  GH_RUNNER_PAT: ${{ secrets.GT_0XFE10 }} # 设置可创建 self-hosted runner token 的 PAT（workflow + admin:org 自托管）

  RUNNER_NAME_PREFIX: ecs-runner
  # RUNNER_VERSION: 2.330.0

jobs:
  prepare-password:
    name: Generate ECS instance password
    runs-on: ubuntu-latest
    outputs:
      instance-password: ${{ steps.generate.outputs.password }}
    steps:
      - id: generate
        name: Generate strong password
        run: |
          # Generate 24-char password with mixed case, digits, and allowed special chars
          pw=$(openssl rand -base64 32 | tr -dc 'a-zA-Z0-9()~!@#$%^&*-_+=|<>?/' | head -c24)
          echo "password=$pw" >> "$GITHUB_OUTPUT"

  provision-runner:
    name: Provision ECS runner (Hong Kong)
    needs: prepare-password
    runs-on: ubuntu-latest
    outputs:
      runner-label: ${{ steps.start.outputs.runner-label }}
      runner-name: ${{ steps.start.outputs.runner-name }}
      instance-id: ${{ steps.start.outputs.instance-id }}
    steps:
      - uses: actions/checkout@v6
      - name: Start Aliyun ECS GitHub runner
        id: start
        uses: ./github-actions/ecs-github-runner
        with:
          mode: start
          github_owner: ${{ github.repository_owner }}
          github_repository: ${{ github.event.repository.name }}
          github_pat: ${{ env.GH_RUNNER_PAT }}
          ali_access_key: ${{ env.ALI_ACCESS_KEY }}
          ali_secret_key: ${{ env.ALI_SECRET_KEY }}
          ali_region: ${{ env.ECS_REGION }}
          vswitch_id: ${{ env.ECS_VSWITCH_ID }}
          availability_zone: ${{ env.ECS_AVAILABILITY_ZONE }}
          security_group_id: ${{ env.ECS_SECURITY_GROUP_ID }}
          image_id: ${{ env.ECS_IMAGE_ID }}
          runner_label: ${{ env.RUNNER_NAME_PREFIX }}-${{ github.run_id }}-${{ github.run_attempt }}
          runner_additional_labels: ${{ env.ECS_RUNNER_ADDITIONAL_LABELS }}
          runner_name: ${{ env.RUNNER_NAME_PREFIX }}-${{ github.run_id }}-${{ github.run_attempt }}
          ali_ecs_name: ${{ env.RUNNER_NAME_PREFIX }}-${{ github.run_id }}-${{ github.run_attempt }}
          ali_ecs_instance_type: ${{ env.ECS_INSTANCE_TYPE }}
          host_name: ${{ env.RUNNER_NAME_PREFIX }}-${{ github.run_id }}-${{ github.run_attempt }}
          system_disk_size: ${{ env.ECS_SYSTEM_DISK_SIZE }}
          # key_pair_name: "" # 使用密码登录时保持为空
          runner_ephemeral: "false"
          # runner_version: ${{ env.RUNNER_VERSION }}
          instance_password: ${{ needs.prepare-password.outputs.instance-password }}

  run-on-ecs:
    name: Run tests on ECS runner
    needs: provision-runner
    runs-on:
      - self-hosted
      - ${{ needs.provision-runner.outputs.runner-label }}
    steps:
      - name: Show environment info
        run: |
          set -x
          uname -a
          echo "Running on $HOSTNAME (instance ${{ needs.provision-runner.outputs.instance-id }})"

  # test-anyhow:
  #   name: Test anyhow crate on ECS runner
  #   needs:
  #     - provision-runner
  #     - run-on-ecs
  #   runs-on:
  #     - self-hosted
  #     - ${{ needs.provision-runner.outputs.runner-label }}
  #   steps:
  #     - uses: dtolnay/rust-toolchain@stable

  #     - name: Checkout anyhow repository
  #       uses: actions/checkout@v6
  #       with:
  #         repository: dtolnay/anyhow
  #         ref: master
  #         path: anyhow

  #     - name: Cargo build
  #       working-directory: anyhow
  #       run: cargo build

  #     - name: Cargo test
  #       working-directory: anyhow
  #       run: cargo test

  destroy-runner:
    name: Destroy ECS runner
    needs:
      - provision-runner
      - run-on-ecs
      # - test-anyhow
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Destroy Aliyun ECS GitHub runner
        uses: ./github-actions/ecs-github-runner
        with:
          mode: destroy
          github_owner: ${{ github.repository_owner }}
          github_repository: ${{ github.event.repository.name }}
          ali_access_key: ${{ env.ALI_ACCESS_KEY }}
          ali_secret_key: ${{ env.ALI_SECRET_KEY }}
          ali_region: ${{ env.ECS_REGION }}
          vswitch_id: ${{ env.ECS_VSWITCH_ID }}
          availability_zone: ${{ env.ECS_AVAILABILITY_ZONE }}
          security_group_id: ${{ env.ECS_SECURITY_GROUP_ID }}
          image_id: ${{ env.ECS_IMAGE_ID }}

      - name: Test
        run: |
          echo ${{ needs.provision-runner.outputs.runner-label }}
          echo ${{ needs.provision-runner.outputs.runner-name }}
          echo ${{ needs.provision-runner.outputs.instance-id }}

      - name: Remove GitHub runner registration
        env:
          GH_PAT: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          X_RUNNER_NAME: ${{ needs.provision-runner.outputs.runner-name }}
        run: |
          set -euo pipefail
          if [ -z "$GH_PAT" ]; then
            echo "GH_RUNNER_PAT not provided, skip runner cleanup"
            exit 0
          fi
          api="https://api.github.com/repos/$OWNER/$REPO/actions/runners?per_page=100"
          echo "Looking for runner: $X_RUNNER_NAME"

          # Fetch all runners and show them for debugging
          runners_json=$(curl -fsSL -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $GH_PAT" "$api")
          echo "Available runners:"
          echo "$runners_json" | jq -r '.runners[] | "\(.id): \(.name) (status: \(.status))"'

          runner_id=$(echo "$runners_json" | jq -r --arg NAME "$X_RUNNER_NAME" '.runners[] | select(.name == $NAME) | .id' | head -n 1)
          if [ -z "$runner_id" ]; then
            echo "Runner '$X_RUNNER_NAME' not found in repo, nothing to delete."
            exit 0
          fi
          echo "Deleting runner '$X_RUNNER_NAME' (id=$runner_id)"
          curl -fsSL -X DELETE -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $GH_PAT" \
            "https://api.github.com/repos/$OWNER/$REPO/actions/runners/$runner_id"
          echo "Runner deleted successfully"
