# Default values for dev-toolchain.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# Global settings
global:
  # Image registry (can be overridden per toolchain)
  imageRegistry: ghcr.io
  # Default image pull policy
  imagePullPolicy: Always
  # Image pull secrets for private registries
  imagePullSecrets: []
  # Example:
  # imagePullSecrets:
  #   - name: ghcr-secret

# Toolchain instances configuration
# Each entry creates a separate deployment with its own PVC and services
toolchains:
  # First toolchain instance - example
  foo:
    # Enable/disable this toolchain
    enabled: true

    # Hostname for the container
    hostname: tch-foo

    # Container image configuration
    image: repotea-workspace/kangumi/dev-toolchain:latest
    # Override global registry if needed
    # imageRegistry: ghcr.io
    # Override global pull policy if needed
    # imagePullPolicy: Always

    # Machine ID for SSH host key generation (optional)
    # If not set, a random ID will be generated on first boot
    machineId: ""

    # SSH Configuration
    # Configure SSH files for multiple users
    # Structure: sshConfig.<username>.<filename>: <content-or-secretRef>
    #
    # Supported users: root, linuxbrew, or any custom user
    # Supported files: authorized_keys, id_ed25519, id_ed25519.pub, id_rsa, id_rsa.pub, known_hosts, config, etc.
    #
    # Two ways to provide content:
    # 1. Inline content (string or list) - chart will create a Secret
    # 2. External Secret reference - use existing Secret in the cluster
    #
    # Example:
    # sshConfig:
    #   root:
    #     # Inline content - public keys are safe to store here
    #     authorized_keys: |
    #       ssh-ed25519 AAAAC3Nza... user@hostname
    #       ssh-rsa AAAAB3Nza... another@host
    #
    #     # External Secret reference - recommended for private keys
    #     id_ed25519:
    #       secretRef:
    #         name: my-ssh-private-keys
    #         key: root_id_ed25519
    #
    #     # Inline content - public key
    #     id_ed25519.pub: |
    #       ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAbCdE... root@hostname
    #
    #     # External Secret reference
    #     known_hosts:
    #       secretRef:
    #         name: my-ssh-config
    #         key: known_hosts
    #
    #     # Inline content
    #     config: |
    #       Host github.com
    #         IdentityFile ~/.ssh/id_ed25519
    #         StrictHostKeyChecking no
    #
    #   linuxbrew:
    #     authorized_keys: |
    #       ssh-ed25519 AAAAC3Nza... linuxbrew@hostname
    #     id_ed25519:
    #       secretRef:
    #         name: linuxbrew-ssh-keys
    #         key: id_ed25519
    #     id_ed25519.pub: |
    #       ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAA... linuxbrew@hostname
    #
    # Files will be mounted to:
    # - /root/.ssh/<filename> for user "root"
    # - /home/<username>/.ssh/<filename> for other users
    #
    # All files will have permissions 0600 by default
    #
    # Note: Create external Secrets manually before deploying:
    #   kubectl create secret generic my-ssh-private-keys \
    #     --from-file=root_id_ed25519=~/.ssh/id_ed25519 \
    #     -n <namespace>
    sshConfig: {}

    # Network mode configuration
    network:
      # Network mode: "nodePort" or "hostNetwork"
      # - nodePort (default): Uses Service with NodePort, requires port pre-configuration
      # - hostNetwork: Pod uses host network, all ports automatically exposed
      mode: nodePort
      # DNS policy for hostNetwork mode (only effective when mode is hostNetwork)
      dnsPolicy: ClusterFirstWithHostNet

    # Development tools auto-installation (first startup only)
    devTools:
      # Enable auto-installation on first startup
      autoInstall: false

      # Tools to install via Homebrew (from tools.yaml)
      packages: []
      # Example:
      # packages:
      #   - golang
      #   - nodejs
      #   - k8s-tools
      #   - terraform
      #   - docker-compose

    # User initialization scripts
    # Custom scripts to run during container initialization (s6-overlay cont-init phase)
    # Scripts are executed in alphabetical order after system initialization
    userScripts: {}
    # Example:
    # userScripts:
    #   00-setup-env.sh: |
    #     #!/bin/bash
    #     echo "Setting up custom environment..."
    #     export CUSTOM_VAR="value"
    #     echo 'export CUSTOM_VAR="value"' >> /etc/profile.d/99-dev-tools-env.sh
    #
    #   10-install-tools.sh: |
    #     #!/bin/bash
    #     echo "Installing additional tools..."
    #     install-brew-tools.sh neovim tmux htop
    #
    #   20-configure-git.sh: |
    #     #!/bin/bash
    #     git config --global user.name "Your Name"
    #     git config --global user.email "your.email@example.com"

    # Port configuration
    ports:
      # SSH port configuration
      ssh:
        # nodePort mode: container internal port (default 22)
        containerPort: 22
        # nodePort mode: external NodePort
        # hostNetwork mode: actual port sshd listens on
        nodePort: 17000

      # Additional ports (for nodePort mode only)
      # hostNetwork mode: no need to configure, all ports are automatically exposed
      extra: []
      # nodePort mode example:
      # extra:
      #   - name: http
      #     containerPort: 8080
      #     nodePort: 17100
      #     protocol: TCP
      #   - name: https
      #     containerPort: 8443
      #     nodePort: 17101
      #     protocol: TCP

    # Storage configuration
    storage:
      # Main PVC for this toolchain
      pvc:
        # Enable PVC creation
        enabled: true
        # PVC name (auto-generated if not set)
        name: ""
        # Storage class (use cluster default if not set)
        storageClassName: ""
        # PVC size
        size: 100Gi
        # Access mode
        accessMode: ReadWriteOnce

      # Volume mount configuration
      # Maps PVC subdirectories to container paths
      # Example volume mounts (customize as needed):
      volumes: {}
      # Example configuration:
      # volumes:
      #   config:
      #     mountPath: /etc/profile.d/env.sh
      #     subPath: config/env.sh
      #   sshConfig:
      #     mountPath: /etc/ssh/sshd_config.d
      #     subPath: config/sshd_config.d
      #   root:
      #     mountPath: /root
      #     subPath: home/root
      #   home:
      #     mountPath: /home
      #     subPath: home/users
      #   data:
      #     mountPath: /data
      #     subPath: workspace/data
      #   opt:
      #     mountPath: /opt
      #     subPath: workspace/opt
      #   code:
      #     mountPath: /code
      #     subPath: workspace/code

      # Shared PVC (optional, for /data/wwwroot)
      sharedPVC:
        # Enable shared PVC mounting
        enabled: false
        # Shared PVC name (must be created separately or by another toolchain)
        name: dev-shared-wwwroot
        # Storage class for shared PVC (must support ReadWriteMany)
        storageClassName: ""
        # Size (only used if this is the first toolchain to create it)
        size: 50Gi
        # Access mode (must be ReadWriteMany for sharing)
        accessMode: ReadWriteMany
        # Mount path
        mountPath: /data/wwwroot

    # Docker-in-Docker (DinD) sidecar configuration
    dind:
      # Enable DinD sidecar
      enabled: true
      # DinD image
      image: docker:29-dind
      # Override DinD image pull policy
      # pullPolicy: IfNotPresent
      # DinD port configuration
      # Port for Docker daemon to listen on (used with DOCKER_HOST in main container)
      # In hostNetwork mode, each toolchain instance should use a different port
      # to avoid conflicts on the same node
      port: 2375
      # Bind address for Docker daemon (default: 127.0.0.1 for security)
      # Using 127.0.0.1 ensures DinD is only accessible from within the Pod
      # and prevents exposure even when using hostNetwork mode
      bindAddress: "127.0.0.1"
      # DinD storage (for /var/lib/docker)
      # Can be emptyDir or PVC
      storage:
        # Use emptyDir (ephemeral, faster)
        type: emptyDir
        # If using PVC, specify size
        # type: pvc
        # size: 50Gi
      # Additional environment variables for DinD
      env: {}

    # Container resources
    resources:
      limits:
        cpu: "8"
        memory: 32Gi
      requests:
        cpu: "2"
        memory: 4Gi

    # Environment variables for the main container
    env: []
    # Example:
    # env:
    #   - name: TZ
    #     value: Asia/Shanghai
    #   - name: LANG
    #     value: en_US.UTF-8

    # Node selector
    nodeSelector: {}
    # Example:
    # nodeSelector:
    #   kubernetes.io/hostname: node1

    # Tolerations
    tolerations: []

    # Affinity rules
    affinity: {}

  # Second toolchain instance - example (disabled by default)
  bar:
    enabled: false
    hostname: tch-bar
    image: repotea-workspace/kangumi/dev-toolchain:latest
    machineId: ""

    # SSH Configuration
    sshConfig: {}

    # Network mode configuration
    network:
      mode: nodePort
      dnsPolicy: ClusterFirstWithHostNet

    # Development tools auto-installation (first startup only)
    devTools:
      autoInstall: false
      packages: []

    # User initialization scripts
    userScripts: {}

    ports:
      ssh:
        containerPort: 22
        nodePort: 17001
      extra: []

    storage:
      pvc:
        enabled: true
        name: ""
        storageClassName: ""
        size: 100Gi
        accessMode: ReadWriteOnce

      volumes: {}

      sharedPVC:
        enabled: false
        name: dev-shared-wwwroot
        storageClassName: ""
        size: 50Gi
        accessMode: ReadWriteMany
        mountPath: /data/wwwroot

    dind:
      enabled: true
      image: docker:29-dind
      port: 2376
      bindAddress: "127.0.0.1"
      storage:
        type: emptyDir
      env: {}

    resources:
      limits:
        cpu: "8"
        memory: 32Gi
      requests:
        cpu: "2"
        memory: 4Gi

    env: []
    nodeSelector: {}
    tolerations: []
    affinity: {}

# Default DinD configuration
# These values are used for all toolchains unless overridden
dindDefaults:
  # DinD image
  image: docker:29-dind
  # Pull policy
  pullPolicy: IfNotPresent

  # Environment variables for DinD container
  env:
    # Disable TLS for simplicity (containers communicate via localhost)
    DOCKER_TLS_CERTDIR: ""

  # DinD container resources
  resources:
    limits:
      cpu: "4"
      memory: 8Gi
    requests:
      cpu: "1"
      memory: 2Gi

# Service account configuration
serviceAccount:
  # Specifies whether a service account should be created
  create: false
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

# Pod annotations
podAnnotations: {}

# Pod security context
podSecurityContext: {}
  # fsGroup: 2000

# Security context for main container
securityContext: {}
  # capabilities:
  #   drop:
  #   - ALL
  # readOnlyRootFilesystem: true
  # runAsNonRoot: true
  # runAsUser: 1000

# Liveness probe configuration (optional)
livenessProbe:
  enabled: false
  # exec:
  #   command:
  #     - /bin/sh
  #     - -c
  #     - pgrep sshd
  # initialDelaySeconds: 30
  # periodSeconds: 10
  # timeoutSeconds: 5
  # failureThreshold: 3

# Readiness probe configuration (optional)
readinessProbe:
  enabled: false
  # tcpSocket:
  #   port: 22
  # initialDelaySeconds: 10
  # periodSeconds: 5
  # timeoutSeconds: 3
  # failureThreshold: 3
