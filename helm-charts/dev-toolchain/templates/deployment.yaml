{{- range $name, $config := .Values.toolchains }}
{{- if $config.enabled }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "dev-toolchain.deploymentName" (dict "root" $ "name" $name) }}
  labels:
    {{- include "dev-toolchain.instanceLabels" (dict "root" $ "name" $name) | nindent 4 }}
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      {{- include "dev-toolchain.instanceSelectorLabels" (dict "root" $ "name" $name) | nindent 6 }}
  template:
    metadata:
      annotations:
        {{- with $.Values.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      labels:
        {{- include "dev-toolchain.instanceSelectorLabels" (dict "root" $ "name" $name) | nindent 8 }}
    spec:
      {{- if eq ($config.network.mode | default "nodePort") "hostNetwork" }}
      # hostNetwork mode configuration
      hostNetwork: true
      dnsPolicy: {{ $config.network.dnsPolicy | default "ClusterFirstWithHostNet" }}
      {{- end }}
      {{- with $.Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if $.Values.serviceAccount.create }}
      serviceAccountName: {{ include "dev-toolchain.serviceAccountName" $ }}
      {{- end }}
      {{- with $.Values.podSecurityContext }}
      securityContext:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if $config.hostname }}
      hostname: {{ $config.hostname }}
      {{- end }}

      containers:
      # Main container - Development toolchain
      - name: dev-toolchain
        image: {{ include "dev-toolchain.image" (dict "root" $ "config" $config) }}
        imagePullPolicy: {{ include "dev-toolchain.imagePullPolicy" (dict "root" $ "config" $config) }}
        securityContext:
          privileged: true
          {{- with $.Values.securityContext }}
          {{- toYaml . | nindent 10 }}
          {{- end }}
        {{- if $config.devTools.autoInstall }}
        lifecycle:
          postStart:
            exec:
              command:
                - /bin/bash
                - -c
                - |
                  # Step 1: Initialize Homebrew in persistent storage
                  echo "→ Initializing Homebrew..."
                  if /usr/local/lib/dev-tools/install-scripts/init-homebrew.sh; then
                    echo "✓ Homebrew ready"
                  else
                    echo "⚠ Failed to initialize Homebrew"
                    exit 1
                  fi

                  # Ensure Homebrew is in PATH
                  export PATH="/home/linuxbrew/.linuxbrew/bin:/home/linuxbrew/.linuxbrew/sbin:${PATH}"
                  eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

                  # Step 2: Install dev tools via Homebrew
                  {{- if $config.devTools.autoInstall }}
                  echo ""
                  echo "→ Installing dev tools..."

                  {{- range $pkg := $config.devTools.packages }}
                  {{- if kindIs "string" $pkg }}
                  {{- /* Simple string format: just the package name */}}
                  echo "Installing {{ $pkg }}..."

                  # Check if it's a custom tool (not in brew)
                  if [ "{{ $pkg }}" = "devtools" ] || [ "{{ $pkg }}" = "harmonytools" ] || [ "{{ $pkg }}" = "vscode" ]; then
                    # Use custom install script
                    if [ -f /usr/local/lib/dev-tools/install-scripts/install-{{ $pkg }}.sh ]; then
                      /usr/local/lib/dev-tools/install-scripts/install-{{ $pkg }}.sh || echo "⚠ Failed to install {{ $pkg }}"
                    else
                      echo "⚠ Script not found: /usr/local/lib/dev-tools/install-scripts/install-{{ $pkg }}.sh"
                    fi
                  else
                    # Use Homebrew install script
                    if [ -f /usr/local/lib/dev-tools/install-scripts/install-brew-tools.sh ]; then
                      /usr/local/lib/dev-tools/install-scripts/install-brew-tools.sh {{ $pkg }} || echo "⚠ Failed to install {{ $pkg }}"
                    else
                      echo "⚠ Homebrew install script not found"
                    fi
                  fi
                  {{- else if kindIs "map" $pkg }}
                  {{- /* Object format with tap support */}}
                  {{- $pkgName := $pkg.name | default "" }}
                  {{- $pkgTap := $pkg.tap | default "" }}
                  {{- $pkgFormula := $pkg.formula | default $pkgName }}
                  echo "Installing {{ $pkgName }}{{ if $pkgTap }} (from tap: {{ $pkgTap }}){{ end }}..."

                  # Add tap if specified
                  {{- if $pkgTap }}
                  if ! brew tap | grep -q "^{{ $pkgTap }}$"; then
                    echo "→ Adding tap: {{ $pkgTap }}"
                    brew tap {{ $pkgTap }} || echo "⚠ Failed to add tap {{ $pkgTap }}"
                  fi
                  {{- end }}

                  # Install the package
                  if [ -f /usr/local/lib/dev-tools/install-scripts/install-brew-tools.sh ]; then
                    /usr/local/lib/dev-tools/install-scripts/install-brew-tools.sh {{ $pkgFormula }} || echo "⚠ Failed to install {{ $pkgName }}"
                  else
                    echo "⚠ Homebrew install script not found"
                  fi
                  {{- end }}
                  {{- end }}
                  echo "✓ Dev tools installation completed"
                  {{- else }}
                  echo "→ devTools.autoInstall is disabled, skipping installation"
                  {{- end }}
        {{- end }}
        env:
        # Docker runs locally in the container (via dockerd service)
        {{- if $config.hostname }}
        # Custom hostname for shell prompt (used in hostNetwork mode)
        - name: CUSTOM_HOSTNAME
          value: {{ $config.hostname | quote }}
        {{- end }}
        {{- if $config.machineId }}
        - name: MACHINE_ID
          value: {{ $config.machineId | quote }}
        {{- end }}
        {{- with $config.env }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        ports:
        {{- if eq ($config.network.mode | default "nodePort") "hostNetwork" }}
        # hostNetwork mode: declare actual listening port
        - name: ssh
          containerPort: {{ $config.ports.ssh.nodePort }}
          protocol: TCP
        {{- else }}
        # nodePort mode: standard port declaration
        - name: ssh
          containerPort: {{ $config.ports.ssh.containerPort }}
          protocol: TCP
        {{- range $config.ports.extra }}
        - name: {{ .name }}
          containerPort: {{ .containerPort }}
          protocol: {{ .protocol | default "TCP" }}
        {{- end }}
        {{- end }}
        {{- if $.Values.livenessProbe.enabled }}
        livenessProbe:
          {{- omit $.Values.livenessProbe "enabled" | toYaml | nindent 10 }}
        {{- end }}
        {{- if $.Values.readinessProbe.enabled }}
        readinessProbe:
          {{- omit $.Values.readinessProbe "enabled" | toYaml | nindent 10 }}
        {{- end }}
        {{- with $config.resources }}
        resources:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        volumeMounts:
        {{- if eq ($config.network.mode | default "nodePort") "hostNetwork" }}
        # hostNetwork mode: mount SSH port configuration
        - name: sshd-config
          mountPath: /etc/ssh/sshd_config.d/port.conf
          subPath: port.conf
        {{- end }}
        {{- if hasKey $config "sshConfig" }}
        # SSH configuration (multi-user support)
        {{- range $user, $userFiles := $config.sshConfig }}
        {{- $homeDir := "/root" }}
        {{- if ne $user "root" }}
        {{- $homeDir = printf "/home/%s" $user }}
        {{- end }}
        {{- range $filename, $content := $userFiles }}
        {{- if kindIs "map" $content }}
        {{- if hasKey $content "secretRef" }}
        # SSH file from external secret: {{ $filename }}
        - name: ssh-{{ $user }}-{{ $filename | replace "." "-" | replace "_" "-" }}
          mountPath: {{ $homeDir }}/.ssh/{{ $filename }}
          subPath: {{ $content.secretRef.key | default $filename }}
          readOnly: true
        {{- end }}
        {{- else }}
        # SSH file from inline content: {{ $filename }}
        - name: ssh-{{ $user }}
          mountPath: {{ $homeDir }}/.ssh/{{ $filename }}
          subPath: {{ $filename }}
          readOnly: true
        {{- end }}
        {{- end }}
        {{- end }}
        {{- end }}
        {{- if $config.storage.pvc.enabled }}
        {{- range $volName, $volConfig := $config.storage.volumes }}
        - name: toolchain-data
          mountPath: {{ $volConfig.mountPath }}
          {{- if $volConfig.subPath }}
          subPath: {{ $volConfig.subPath }}
          {{- end }}
        {{- end }}
        {{- end }}
        {{- if and $config.storage.sharedPVC $config.storage.sharedPVC.enabled }}
        - name: shared-wwwroot
          mountPath: {{ $config.storage.sharedPVC.mountPath }}
        {{- end }}
        {{- if $config.userScripts }}
        # User initialization scripts
        - name: user-scripts
          mountPath: /usr/local/lib/dev-tools/user-scripts
          readOnly: true
        {{- end }}
        {{- if $config.storage.pvc.enabled }}
        # Docker storage (dockerd runs in main container, from PVC subPath)
        - name: toolchain-data
          mountPath: /var/lib/docker
          subPath: docker
        {{- end }}
      volumes:
      {{- if eq ($config.network.mode | default "nodePort") "hostNetwork" }}
      # hostNetwork mode: SSH port configuration
      - name: sshd-config
        configMap:
          name: {{ include "dev-toolchain.configMapName" (dict "root" $ "name" $name) }}
      {{- end }}
      {{- if hasKey $config "sshConfig" }}
      # SSH configuration (multi-user support)
      {{- range $user, $userFiles := $config.sshConfig }}
      {{- $hasInlineContent := false }}
      {{- range $filename, $content := $userFiles }}
      {{- if not (kindIs "map" $content) }}
      {{- $hasInlineContent = true }}
      {{- end }}
      {{- end }}
      {{- if $hasInlineContent }}
      # SSH inline content for user: {{ $user }}
      - name: ssh-{{ $user }}
        secret:
          secretName: tch-{{ $name }}-ssh-{{ $user }}
          defaultMode: 0600
      {{- end }}
      {{- range $filename, $content := $userFiles }}
      {{- if kindIs "map" $content }}
      {{- if hasKey $content "secretRef" }}
      # SSH external secret for {{ $user }}/{{ $filename }}
      - name: ssh-{{ $user }}-{{ $filename | replace "." "-" | replace "_" "-" }}
        secret:
          secretName: {{ $content.secretRef.name }}
          defaultMode: 0600
          items:
          - key: {{ $content.secretRef.key | default $filename }}
            path: {{ $content.secretRef.key | default $filename }}
      {{- end }}
      {{- end }}
      {{- end }}
      {{- end }}
      {{- end }}
      {{- if $config.storage.pvc.enabled }}
      - name: toolchain-data
        persistentVolumeClaim:
          claimName: {{ include "dev-toolchain.pvcName" (dict "root" $ "name" $name "config" $config) }}
      {{- end }}
      {{- if and $config.storage.sharedPVC $config.storage.sharedPVC.enabled }}
      - name: shared-wwwroot
        persistentVolumeClaim:
          claimName: {{ include "dev-toolchain.sharedPvcName" (dict "root" $ "config" $config) }}
      {{- end }}
      {{- if $config.userScripts }}
      # User initialization scripts
      - name: user-scripts
        configMap:
          name: {{ include "dev-toolchain.deploymentName" (dict "root" $ "name" $name) }}-user-scripts
          defaultMode: 0755
      {{- end }}
      {{- with $config.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $config.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $config.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}
{{- end }}
