{{- range $name, $config := .Values.toolchains }}
{{- if $config.enabled }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "dev-toolchain.deploymentName" (dict "root" $ "name" $name) }}
  labels:
    {{- include "dev-toolchain.instanceLabels" (dict "root" $ "name" $name) | nindent 4 }}
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      {{- include "dev-toolchain.instanceSelectorLabels" (dict "root" $ "name" $name) | nindent 6 }}
  template:
    metadata:
      annotations:
        {{- with $.Values.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      labels:
        {{- include "dev-toolchain.instanceSelectorLabels" (dict "root" $ "name" $name) | nindent 8 }}
    spec:
      {{- with $.Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if $.Values.serviceAccount.create }}
      serviceAccountName: {{ include "dev-toolchain.serviceAccountName" $ }}
      {{- end }}
      {{- with $.Values.podSecurityContext }}
      securityContext:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if $config.hostname }}
      hostname: {{ $config.hostname }}
      {{- end }}
      containers:
      # Main container - Development toolchain
      - name: dev-toolchain
        image: {{ include "dev-toolchain.image" (dict "root" $ "config" $config) }}
        imagePullPolicy: {{ include "dev-toolchain.imagePullPolicy" (dict "root" $ "config" $config) }}
        {{- with $.Values.securityContext }}
        securityContext:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        env:
        # Docker host points to DinD sidecar
        - name: DOCKER_HOST
          value: tcp://localhost:2375
        {{- if $config.machineId }}
        - name: MACHINE_ID
          value: {{ $config.machineId | quote }}
        {{- end }}
        {{- with $config.env }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        ports:
        - name: ssh
          containerPort: {{ $config.ports.ssh.containerPort }}
          protocol: TCP
        {{- range $config.ports.extra }}
        - name: {{ .name }}
          containerPort: {{ .containerPort }}
          protocol: {{ .protocol | default "TCP" }}
        {{- end }}
        {{- if $.Values.livenessProbe.enabled }}
        livenessProbe:
          {{- omit $.Values.livenessProbe "enabled" | toYaml | nindent 10 }}
        {{- end }}
        {{- if $.Values.readinessProbe.enabled }}
        readinessProbe:
          {{- omit $.Values.readinessProbe "enabled" | toYaml | nindent 10 }}
        {{- end }}
        {{- with $config.resources }}
        resources:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        volumeMounts:
        {{- if $config.storage.pvc.enabled }}
        {{- range $volName, $volConfig := $config.storage.volumes }}
        - name: toolchain-data
          mountPath: {{ $volConfig.mountPath }}
          {{- if $volConfig.subPath }}
          subPath: {{ $volConfig.subPath }}
          {{- end }}
        {{- end }}
        {{- end }}
        {{- if $config.storage.sharedPVC.enabled }}
        - name: shared-wwwroot
          mountPath: {{ $config.storage.sharedPVC.mountPath }}
        {{- end }}
      {{- if $config.dind.enabled }}
      # DinD sidecar - Docker daemon
      - name: dind
        image: {{ include "dev-toolchain.dindImage" (dict "root" $ "config" $config) }}
        imagePullPolicy: {{ include "dev-toolchain.dindImagePullPolicy" (dict "root" $ "config" $config) }}
        securityContext:
          privileged: true
        env:
        - name: DOCKER_TLS_CERTDIR
          value: {{ $.Values.dindDefaults.env.DOCKER_TLS_CERTDIR | quote }}
        {{- if $config.dind.env }}
        {{- range $key, $value := $config.dind.env }}
        - name: {{ $key }}
          value: {{ $value | quote }}
        {{- end }}
        {{- end }}
        {{- with $config.dind.resources | default $.Values.dindDefaults.resources }}
        resources:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        volumeMounts:
        - name: dind-storage
          mountPath: /var/lib/docker
      {{- end }}
      volumes:
      {{- if $config.storage.pvc.enabled }}
      - name: toolchain-data
        persistentVolumeClaim:
          claimName: {{ include "dev-toolchain.pvcName" (dict "root" $ "name" $name "config" $config) }}
      {{- end }}
      {{- if $config.storage.sharedPVC.enabled }}
      - name: shared-wwwroot
        persistentVolumeClaim:
          claimName: {{ include "dev-toolchain.sharedPvcName" (dict "root" $ "config" $config) }}
      {{- end }}
      {{- if $config.dind.enabled }}
      - name: dind-storage
        {{- $storageType := "emptyDir" }}
        {{- if $config.dind.storage }}
          {{- $storageType = $config.dind.storage.type | default "emptyDir" }}
        {{- end }}
        {{- if eq $storageType "emptyDir" }}
        emptyDir: {}
        {{- else if eq $storageType "pvc" }}
        persistentVolumeClaim:
          claimName: {{ printf "%s-%s-dind" (include "dev-toolchain.fullname" $) $name }}
        {{- end }}
      {{- end }}
      {{- with $config.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $config.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $config.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}
{{- end }}
