{{- range $name, $config := .Values.toolchains }}
{{- if $config.enabled }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "dev-toolchain.deploymentName" (dict "root" $ "name" $name) }}
  labels:
    {{- include "dev-toolchain.instanceLabels" (dict "root" $ "name" $name) | nindent 4 }}
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      {{- include "dev-toolchain.instanceSelectorLabels" (dict "root" $ "name" $name) | nindent 6 }}
  template:
    metadata:
      annotations:
        {{- with $.Values.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      labels:
        {{- include "dev-toolchain.instanceSelectorLabels" (dict "root" $ "name" $name) | nindent 8 }}
    spec:
      {{- if eq ($config.network.mode | default "nodePort") "hostNetwork" }}
      # hostNetwork mode configuration
      hostNetwork: true
      dnsPolicy: {{ $config.network.dnsPolicy | default "ClusterFirstWithHostNet" }}
      {{- end }}
      {{- with $.Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if $.Values.serviceAccount.create }}
      serviceAccountName: {{ include "dev-toolchain.serviceAccountName" $ }}
      {{- end }}
      {{- with $.Values.podSecurityContext }}
      securityContext:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if $config.hostname }}
      hostname: {{ $config.hostname }}
      {{- end }}

      containers:
      # Main container - Development toolchain
      - name: dev-toolchain
        image: {{ include "dev-toolchain.image" (dict "root" $ "config" $config) }}
        imagePullPolicy: {{ include "dev-toolchain.imagePullPolicy" (dict "root" $ "config" $config) }}
        {{- with $.Values.securityContext }}
        securityContext:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        {{- if $config.devTools.autoInstall }}
        lifecycle:
          postStart:
            exec:
              command:
                - /bin/bash
                - -c
                - |
                  # Step 1: Initialize Homebrew in persistent storage
                  echo "→ Initializing Homebrew..."
                  if /usr/local/lib/dev-tools/install-scripts/init-homebrew.sh; then
                    echo "✓ Homebrew ready"
                  else
                    echo "⚠ Failed to initialize Homebrew"
                    exit 1
                  fi

                  # Ensure Homebrew is in PATH
                  export PATH="/opt/homebrew/bin:/opt/homebrew/sbin:${PATH}"
                  eval "$(/opt/homebrew/bin/brew shellenv)"

                  # Step 2: Install dev tools via Homebrew
                  {{- if $config.devTools.autoInstall }}
                  echo ""
                  echo "→ Installing dev tools..."

                  {{- range $config.devTools.packages }}
                  echo "Installing {{ . }}..."

                  # Check if it's a custom tool (not in brew)
                  if [ "{{ . }}" = "devtools" ] || [ "{{ . }}" = "harmonytools" ] || [ "{{ . }}" = "vscode" ]; then
                    # Use custom install script
                    if [ -f /usr/local/lib/dev-tools/install-scripts/install-{{ . }}.sh ]; then
                      /usr/local/lib/dev-tools/install-scripts/install-{{ . }}.sh || echo "⚠ Failed to install {{ . }}"
                    else
                      echo "⚠ Script not found: /usr/local/lib/dev-tools/install-scripts/install-{{ . }}.sh"
                    fi
                  else
                    # Use Homebrew install script
                    if [ -f /usr/local/lib/dev-tools/install-scripts/install-brew-tools.sh ]; then
                      /usr/local/lib/dev-tools/install-scripts/install-brew-tools.sh {{ . }} || echo "⚠ Failed to install {{ . }}"
                    else
                      echo "⚠ Homebrew install script not found"
                    fi
                  fi
                  {{- end }}
                  echo "✓ Dev tools installation completed"
                  {{- else }}
                  echo "→ devTools.autoInstall is disabled, skipping installation"
                  {{- end }}
        {{- end }}
        env:
        # Docker host points to DinD sidecar
        - name: DOCKER_HOST
          value: tcp://localhost:{{ $config.dind.port | default 2375 }}
        {{- if $config.hostname }}
        # Custom hostname for shell prompt (used in hostNetwork mode)
        - name: CUSTOM_HOSTNAME
          value: {{ $config.hostname | quote }}
        {{- end }}
        {{- if $config.machineId }}
        - name: MACHINE_ID
          value: {{ $config.machineId | quote }}
        {{- end }}
        {{- with $config.env }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        ports:
        {{- if eq ($config.network.mode | default "nodePort") "hostNetwork" }}
        # hostNetwork mode: declare actual listening port
        - name: ssh
          containerPort: {{ $config.ports.ssh.nodePort }}
          protocol: TCP
        {{- else }}
        # nodePort mode: standard port declaration
        - name: ssh
          containerPort: {{ $config.ports.ssh.containerPort }}
          protocol: TCP
        {{- range $config.ports.extra }}
        - name: {{ .name }}
          containerPort: {{ .containerPort }}
          protocol: {{ .protocol | default "TCP" }}
        {{- end }}
        {{- end }}
        {{- if $.Values.livenessProbe.enabled }}
        livenessProbe:
          {{- omit $.Values.livenessProbe "enabled" | toYaml | nindent 10 }}
        {{- end }}
        {{- if $.Values.readinessProbe.enabled }}
        readinessProbe:
          {{- omit $.Values.readinessProbe "enabled" | toYaml | nindent 10 }}
        {{- end }}
        {{- with $config.resources }}
        resources:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        volumeMounts:
        {{- if eq ($config.network.mode | default "nodePort") "hostNetwork" }}
        # hostNetwork mode: mount SSH port configuration
        - name: sshd-config
          mountPath: /etc/ssh/sshd_config.d/port.conf
          subPath: port.conf
        {{- end }}
        {{- if $config.storage.pvc.enabled }}
        {{- range $volName, $volConfig := $config.storage.volumes }}
        - name: toolchain-data
          mountPath: {{ $volConfig.mountPath }}
          {{- if $volConfig.subPath }}
          subPath: {{ $volConfig.subPath }}
          {{- end }}
        {{- end }}
        {{- end }}
        {{- if and $config.storage.sharedPVC $config.storage.sharedPVC.enabled }}
        - name: shared-wwwroot
          mountPath: {{ $config.storage.sharedPVC.mountPath }}
        {{- end }}
      {{- if $config.dind.enabled }}
      # DinD sidecar - Docker daemon
      - name: dind
        image: {{ include "dev-toolchain.dindImage" (dict "root" $ "config" $config) }}
        imagePullPolicy: {{ include "dev-toolchain.dindImagePullPolicy" (dict "root" $ "config" $config) }}
        securityContext:
          privileged: true
        {{- $dindPort := $config.dind.port | default 2375 }}
        {{- $dindBindAddr := $config.dind.bindAddress | default "127.0.0.1" }}
        command:
        - dockerd
        - --host=tcp://{{ $dindBindAddr }}:{{ $dindPort }}
        {{- if eq ($.Values.dindDefaults.env.DOCKER_TLS_CERTDIR | default "") "" }}
        - --tls=false
        {{- end }}
        env:
        - name: DOCKER_TLS_CERTDIR
          value: {{ $.Values.dindDefaults.env.DOCKER_TLS_CERTDIR | quote }}
        {{- if $config.dind.env }}
        {{- range $key, $value := $config.dind.env }}
        - name: {{ $key }}
          value: {{ $value | quote }}
        {{- end }}
        {{- end }}
        {{- with $config.dind.resources | default $.Values.dindDefaults.resources }}
        resources:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        volumeMounts:
        - name: dind-storage
          mountPath: /var/lib/docker
      {{- end }}
      volumes:
      {{- if eq ($config.network.mode | default "nodePort") "hostNetwork" }}
      # hostNetwork mode: SSH port configuration
      - name: sshd-config
        configMap:
          name: {{ include "dev-toolchain.configMapName" (dict "root" $ "name" $name) }}
      {{- end }}
      {{- if $config.storage.pvc.enabled }}
      - name: toolchain-data
        persistentVolumeClaim:
          claimName: {{ include "dev-toolchain.pvcName" (dict "root" $ "name" $name "config" $config) }}
      {{- end }}
      {{- if and $config.storage.sharedPVC $config.storage.sharedPVC.enabled }}
      - name: shared-wwwroot
        persistentVolumeClaim:
          claimName: {{ include "dev-toolchain.sharedPvcName" (dict "root" $ "config" $config) }}
      {{- end }}
      {{- if $config.dind.enabled }}
      - name: dind-storage
        {{- $storageType := "emptyDir" }}
        {{- if $config.dind.storage }}
          {{- $storageType = $config.dind.storage.type | default "emptyDir" }}
        {{- end }}
        {{- if eq $storageType "emptyDir" }}
        emptyDir: {}
        {{- else if eq $storageType "pvc" }}
        persistentVolumeClaim:
          claimName: {{ printf "%s-%s-dind" (include "dev-toolchain.fullname" $) $name }}
        {{- end }}
      {{- end }}
      {{- with $config.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $config.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $config.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}
{{- end }}
