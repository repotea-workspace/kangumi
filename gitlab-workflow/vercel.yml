.deploy-vercel: &deploy-vercel
  image: node:20-alpine
  variables:
    SCRIPT_RUN: 'true'
    SCRIPT_INSTALL: 'npm i'
    SCRIPT_BUILD: 'npm run build'
    WORKDIR: '.'
    PROJECT_NAME: ''
    VERCEL_GROUP: ''
    PROD_MODE: ''
    DIST_PATH: 'dist'
    ENV_CI: 'false'
    ALIAS_DOMAIN: ''
  script:
    - |
      if [ -z "${VERCEL_TOKEN}" ]; then
        echo 'Missing VERCEL_TOKEN'
        exit 1
      fi
      if [ -z "${VERCEL_GROUP}" ]; then
        echo 'Missing VERCEL_GROUP'
        exit 1
      fi

      npm i -g vercel


      cd ${WORKDIR}

      PATH_PROJECT=${CI_PROJECT_DIR}
      DIR_NAME=$(basename "${PATH_PROJECT}")
      REPO_NAME=${PROJECT_NAME:-${CI_PROJECT_NAME}}
      PROD_MODE=${PROD_MODE}
      DIST_PATH=${DIST_PATH}

      INPUT_ALIAS_DOMAIN=${ALIAS_DOMAIN}
      ALL_ALIAS_DOMAIN=$(echo "${INPUT_ALIAS_DOMAIN}" | sed ":a;$!N;s/\n/ /g;ba" | sed "s/,/ /g")
      DOMAIN_IDENTIFY_KEYWORD=.

      if [ "${SCRIPT_RUN}" == "true" ]; then
        export CI=${ENV_CI}
        ${SCRIPT_INSTALL}
        ${SCRIPT_BUILD}
        cd ${PATH_PROJECT}
      fi


      if [ "${DIST_PATH}" == "." ]; then
        cd ..
        if [ "${DIR_NAME}" != "${REPO_NAME}" ]; then
          cp -r ${DIR_NAME} ${REPO_NAME}
        fi
      else
        if [ "${DIST_PATH}" != "${REPO_NAME}" ]; then
          mv ${DIST_PATH} ${REPO_NAME}
        fi

        PATH_VERCEL_JSON=./vercel.json
        if [ -f "${PATH_VERCEL_JSON}" ]; then
          mv ${PATH_VERCEL_JSON} ${REPO_NAME}/
        fi
      fi

      cd ${REPO_NAME}

      VERCEL="vercel ${VERCEL_TOKEN:+--token $VERCEL_TOKEN} ${VERCEL_GROUP:+--scope $VERCEL_GROUP}"

      ${VERCEL} link --confirm

      ${VERCEL} ${PROD_MODE:+--prod} deploy | tee deploy.log

      DEPLOYMENT_URL=$(cat deploy.log)

      for DOMAIN in ${ALL_ALIAS_DOMAIN}
      do
        if test "${DOMAIN#*$DOMAIN_IDENTIFY_KEYWORD}" != "${DOMAIN}"
        then
          echo "alias with custom domain: ${DOMAIN}"
          ${VERCEL} alias ${DEPLOYMENT_URL} ${DOMAIN}
        else
          echo "alias with bundle domain: ${DOMAIN}.vercel.app"
          ${VERCEL} alias ${DEPLOYMENT_URL} ${DOMAIN}.vercel.app
        fi
      done

      content="${DEPLOYMENT_URL//'%'/'%25'}"
      content="${content//$'\n'/'%0A'}"
      content="${content//$'\r'/'%0D'}"
      PREVIEW_LINK="${content}"

      for DOMAIN in ${ALL_ALIAS_DOMAIN}
      do
        if test "${DOMAIN#*\*}" != "${DOMAIN}"; then
          continue
        fi
        if test "${DOMAIN#*$DOMAIN_IDENTIFY_KEYWORD}" != "${DOMAIN}"
        then
          PREVIEW_LINK="${PREVIEW_LINK} https://${DOMAIN}"
        else
          PREVIEW_LINK="${PREVIEW_LINK} https://${DOMAIN}.vercel.app"
        fi
      done

      rm -rf deploy.log

      echo ''


      if [ "${DIST_PATH}" == "." ]; then
        cd ..
        if [ "${DIR_NAME}" != "${REPO_NAME}" ]; then
          rm -rf ${DIR_NAME}
          mv ${REPO_NAME} ${DIR_NAME}
        fi
        cd ${DIR_NAME}
      fi


